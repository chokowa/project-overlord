<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project OVERLORD: Vertical Ops</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <style>
        :root {
            --bg-color: #0b0c10;
            --panel-bg: #1f2833;
            --accent-cyan: #66fcf1;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --text-main: #c5c6c7;
            --slot-border: #45a29e;
        }

        body, html { 
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: #000; color: var(--text-main); 
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif; 
            overflow: hidden; user-select: none;
            display: flex; justify-content: center; align-items: center;
        }

        #device-frame {
            position: relative;
            width: 100%; height: 100%; max-width: 600px; max-height: 900px;
            background: radial-gradient(circle at 50% 80%, #2c3e50 0%, #000000 100%);
            border: 2px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        #game-canvas { 
            width: 100%; height: 100%; 
            flex-grow: 1; display: block; 
        }

        /* --- PoE Style HUD (Bottom Panel) --- */
        #bottom-hud {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 140px;
            background: linear-gradient(to top, #0b0c10 80%, transparent 100%);
            display: flex; justify-content: space-between; align-items: flex-end;
            padding-bottom: 10px; z-index: 50;
            pointer-events: none; /* ä¸‹ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
        }

        /* Orbs (HP / Energy) */
        .orb-container {
            width: 100px; height: 100px;
            position: relative;
            margin: 0 10px;
            pointer-events: auto;
            border-radius: 50%;
            background: #111;
            border: 4px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            overflow: hidden;
        }
        .orb-fill {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            transition: height 0.2s;
        }
        .orb-fill.hp {
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #c0392b);
            box-shadow: 0 0 20px #c0392b;
        }
        .orb-fill.energy {
            background: radial-gradient(circle at 30% 30%, #74b9ff, #2980b9);
            box-shadow: 0 0 20px #2980b9;
        }
        .orb-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: bold; font-size: 16px; color: #fff; text-shadow: 1px 1px 2px #000;
            pointer-events: none;
        }
        .orb-label {
            position: absolute; bottom: -20px; width: 100%; text-align: center;
            font-size: 12px; font-weight: bold; color: #aaa;
        }

        /* Center Panel (Controls & Stats) */
        .center-panel {
            flex-grow: 1; height: 100px;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            pointer-events: auto;
            margin-bottom: 5px;
        }

        .stats-row {
            display: flex; gap: 15px; margin-bottom: 5px;
            font-size: 12px; font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        .stat-item { color: #fff; display: flex; align-items: center; gap: 4px; }
        .stat-gold { color: #f1c40f; }
        .stat-sp { color: #00d2d3; }

        .xp-bar-container {
            width: 90%; height: 6px; background: #333;
            border: 1px solid #555; border-radius: 3px;
            margin-bottom: 8px; overflow: hidden;
        }
        .xp-bar-fill {
            height: 100%; background: #f1c40f; width: 0%; transition: width 0.3s;
        }

        .control-buttons {
            display: flex; gap: 10px;
        }
        .hud-btn {
            width: 45px; height: 45px;
            background: #1f2833; border: 2px solid #45a29e;
            border-radius: 8px; color: #66fcf1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: 0.1s;
        }
        .hud-btn:active { transform: scale(0.95); }
        .hud-btn span { font-size: 8px; margin-top: 2px; }
        .hud-btn.active { background: #66fcf1; color: #000; }

        /* Wave Info (Top Center - Minimal) */
        #top-info {
            position: absolute; top: 10px; left: 0; width: 100%;
            text-align: center; pointer-events: none;
        }
        .wave-badge {
            display: inline-block; background: rgba(0,0,0,0.6); 
            border: 1px solid #f1c40f; color: #f1c40f;
            padding: 5px 15px; border-radius: 15px;
            font-weight: bold; font-size: 14px;
        }
        .wave-progress {
            width: 200px; height: 4px; background: rgba(255,255,255,0.2);
            margin: 5px auto; border-radius: 2px; overflow: hidden;
        }
        .wave-progress-fill {
            height: 100%; background: #f1c40f; width: 0%;
        }

        /* --- Modals & Overlays --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 15, 20, 0.95); z-index: 100;
            display: flex; flex-direction: column;
            transition: opacity 0.2s; opacity: 1; pointer-events: auto;
        }
        .modal-overlay.hidden { opacity: 0; pointer-events: none; }

        .modal-header {
            padding: 15px; border-bottom: 2px solid #45a29e;
            display: flex; justify-content: space-between; align-items: center;
            background: #0b0c10;
        }
        .modal-title { font-size: 18px; font-weight: bold; color: #66fcf1; }
        .close-btn { background: none; border: none; color: #e74c3c; font-size: 28px; cursor: pointer; }

        .modal-content { flex-grow: 1; padding: 10px; overflow-y: auto; }

        /* Upgrade Selection (Vampire Survivors Style) */
        #upgrade-selection-modal {
            background: rgba(0, 0, 0, 0.85);
            align-items: center; justify-content: center;
        }
        .upgrade-container {
            display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 400px;
        }
        .upgrade-card {
            background: linear-gradient(135deg, #2c3e50, #1a1a2e);
            border: 2px solid #bdc3c7; border-radius: 8px;
            padding: 15px; color: #fff; cursor: pointer;
            display: flex; align-items: center; gap: 15px;
            transition: transform 0.2s;
            position: relative; overflow: hidden;
        }
        .upgrade-card:hover { transform: scale(1.03); border-color: #f1c40f; background: linear-gradient(135deg, #34495e, #2c3e50); }
        .upgrade-card.rare { border-color: #f1c40f; }
        .upgrade-icon { font-size: 32px; width: 50px; text-align: center; }
        .upgrade-info { flex: 1; }
        .upgrade-name { font-weight: bold; font-size: 16px; color: #f1c40f; margin-bottom: 4px; }
        .upgrade-desc { font-size: 12px; color: #ccc; line-height: 1.3; }
        .upgrade-btn {
            margin-top: 10px; padding: 10px; background: #333; border: 1px solid #777; 
            color: #fff; cursor: pointer; border-radius: 4px; text-align: center;
        }

        /* Skill Tree Container (Zoomable) */
        #skill-tree-viewport {
            width: 100%; height: 100%; overflow: hidden; position: relative;
            background: radial-gradient(circle, #222 0%, #000 100%);
            touch-action: none; /* Prevent browser default zoom */
        }
        #skill-tree-content {
            transform-origin: 0 0;
            position: absolute;
        }

        /* Skill Tree Nodes Styling */
        .tree-node {
            position: absolute;
            width: 40px; height: 40px;
            transform: translate(-50%, -50%);
            background: #222; border: 2px solid #555; border-radius: 50%;
            cursor: pointer; z-index: 2;
            transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .tree-node:hover { transform: translate(-50%, -50%) scale(1.2); border-color: #fff; z-index: 10; }
        .tree-node.allocated { background: #f1c40f; border-color: #fff; box-shadow: 0 0 15px #f1c40f; }

        .node-start { width: 60px; height: 60px; border-color: #00d2d3; background: #1a1a2e; box-shadow: 0 0 20px #00d2d3; }

        .node-keystone { 
            width: 70px; height: 70px; 
            border-radius: 8px; border-width: 3px; border-color: #e74c3c; 
            transform: translate(-50%, -50%) rotate(45deg); 
        }
        .node-keystone.allocated { background: #c0392b; border-color: #ff7675; box-shadow: 0 0 25px #e74c3c; }
        .node-keystone:hover { transform: translate(-50%, -50%) rotate(45deg) scale(1.1); }
        /* Fix text rotation inside keystone */
        .node-keystone > div { transform: rotate(-45deg); } 

        .node-medium { width: 50px; height: 50px; border-color: #a29bfe; border-width: 2px; }
        .node-medium.allocated { background: #6c5ce7; }

        .node-label {
            position: absolute;
            top: 105%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #fff;
            text-shadow: 0 0 4px #000;
            white-space: nowrap;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 20;
        }

        /* --- Specific Modal Styles --- */
        .equipment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gem-slot {
            height: 60px; background: rgba(0,0,0,0.5); border: 1px solid #555;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px; font-size: 12px; color: #888;
        }
        #inventory-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .inv-item { 
            aspect-ratio: 1; border: 1px solid #444; border-radius: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 10px; background: rgba(255,255,255,0.05);
        }

        /* Shop Grid */
        #shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* Guide Colors */
        .slot-active-bg { background: rgba(231, 76, 60, 0.1); border-color: #c0392b !important; }
        .slot-support-bg { background: rgba(46, 204, 113, 0.1); border-color: #27ae60 !important; }

        /* Help Modal Text */
        .help-section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .help-title { color: #f1c40f; font-weight: bold; margin-bottom: 5px; }
        .help-desc { font-size: 12px; color: #ccc; line-height: 1.4; }

    </style>
</head>
<body>
    <div id="device-frame">
        <canvas id="game-canvas" width="600" height="900"></canvas>
        
        <div id="top-info">
            <div class="wave-badge" id="wave-info">WAVE 1</div>
            <div class="wave-progress">
                <div id="wave-bar-fill" class="wave-progress-fill"></div>
            </div>
            <div id="game-stats" style="font-size: 10px; color: #aaa; margin-top: 4px;">åˆæœŸåŒ–ä¸­...</div>
        </div>

        <div id="bottom-hud">
            <div class="orb-container left">
                <div id="hp-orb-fill" class="orb-fill hp" style="height: 100%;"></div>
                <div class="orb-text">HP</div>
                <div class="orb-label" id="hp-text">500</div>
            </div>

            <div class="center-panel">
                <div class="stats-row">
                    <div class="stat-item stat-gold">ğŸ’° <span id="gold-display">0</span></div>
                    <div class="stat-item stat-sp">âœ¨ SP: <span id="sp-display">0</span></div>
                </div>
                
                <div class="xp-bar-container">
                    <div id="xp-bar-fill" class="xp-bar-fill"></div>
                </div>
                <div style="font-size: 8px; color:#aaa; margin-bottom: 5px;">ã‘ã„ã‘ã‚“ã¡</div>

                <div class="control-buttons">
                    <div class="hud-btn" onclick="toggleMenu('dock-modal')">
                        ğŸ’<span>ãã†ã³</span>
                    </div>
                    <div class="hud-btn" onclick="toggleMenu('skill-tree-modal')">
                        ğŸŒ²<span>ãƒ„ãƒªãƒ¼</span>
                    </div>
                    <div class="hud-btn" id="btn-shield" 
                         onmousedown="engineState.setShieldState(true)" 
                         onmouseup="engineState.setShieldState(false)"
                         ontouchstart="engineState.setShieldState(true); event.preventDefault();" 
                         ontouchend="engineState.setShieldState(false); event.preventDefault();">
                        ğŸ›¡ï¸<span>ã‚¬ãƒ¼ãƒ‰</span>
                    </div>
                    <div class="hud-btn" onclick="toggleMenu('logic-modal')">
                        ğŸ¤–<span>AI</span>
                    </div>
                    <div class="hud-btn" onclick="toggleMenu('shop-modal')">
                        ğŸ›’<span>åº—</span>
                    </div>
                    <div class="hud-btn" onclick="toggleMenu('help-modal')" style="border-color:#f1c40f; color:#f1c40f;">
                        ?<span>ãƒ˜ãƒ«ãƒ—</span>
                    </div>
                </div>

                <!-- On-Screen Loadout Swap -->
                <div style="position:absolute; top:-30px; left:50%; transform:translateX(-50%); 
                            background:#222; border:1px solid #444; color:#fff; padding:2px 10px; 
                            font-size:10px; border-radius:10px; cursor:pointer; pointer-events:auto;"
                     onclick="engineState.swapLoadout()">
                    â™» SWAP (Qã‚­ãƒ¼)
                </div>
            </div>

            <div class="orb-container right">
                <div id="energy-orb-fill" class="orb-fill energy" style="height: 100%;"></div>
                <div class="orb-text">MP</div>
                <div class="orb-label" id="energy-text">100</div>
            </div>
        </div>

        <div style="position:absolute; bottom:150px; right:10px; width:40px; height:40px; 
             background:rgba(0,0,0,0.5); border:2px solid #fff; color:#fff; border-radius:50%; 
             display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer; z-index:90;"
             onclick="engineState.togglePause()">â¸</div>

        <div id="upgrade-selection-modal" class="modal-overlay hidden">
            <h2 style="color:#f1c40f; text-shadow:0 0 10px orange; margin-bottom:20px;">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</h2>
            <div class="upgrade-container" id="upgrade-options-container">
                </div>
            <div class="upgrade-btn" onclick="closeUpgradeModal()">ã‚ã¨ã§æ±ºã‚ã‚‹ï¼ˆSPã‚’ä¿æŒï¼‰</div>
        </div>

        <div id="dock-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title">ãã†ã³å¤‰æ›´</div>
                <button class="close-btn" onclick="toggleMenu('dock-modal')">Ã—</button>
            </div>
            <div class="modal-content">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="upgrade-btn" style="flex:1" onclick="engineState.selectLoadout(1)">ã‚»ãƒƒãƒˆ I</button>
                    <button class="upgrade-btn" style="flex:1" onclick="engineState.selectLoadout(2)">ã‚»ãƒƒãƒˆ II</button>
                </div>
                <div class="equipment-grid">
                    <div>
                        <div style="text-align:center; font-size:10px; color:#aaa; margin-bottom:4px;">ãƒ¡ã‚¤ãƒ³æ­¦å™¨</div>
                        <div class="gem-slot" id="slot-0" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 0)">ãƒ¡ã‚¤ãƒ³</div>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <div class="gem-slot" id="slot-1" style="flex:1" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 1)">æ”¹é€ </div>
                            <div class="gem-slot" id="slot-2" style="flex:1" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 2)">æ”¹é€ </div>
                        </div>
                    </div>
                    <div>
                        <div style="text-align:center; font-size:10px; color:#aaa; margin-bottom:4px;">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</div>
                        <div class="gem-slot" id="slot-ring" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 'RING')">æŒ‡è¼ª</div>
                        <div class="gem-slot" id="slot-amulet" style="margin-top:5px;" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 'AMULET')">é¦–é£¾ã‚Š</div>
                    </div>
                </div>
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:5px;">æŒã¡ç‰©</div>
                <div id="inventory-grid" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'INVENTORY')"></div>
                <div id="salvage-area" style="margin-top:15px; border:2px dashed #e74c3c; color:#e74c3c; padding:10px; text-align:center; font-size:12px;"
                     ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SALVAGE')">ã“ã“ã«æ¨ã¦ã¦ XP ã«å¤‰æ›</div>
            </div>
        </div>

        <div id="skill-tree-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title">ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼</div>
                <button class="close-btn" onclick="toggleMenu('skill-tree-modal')">Ã—</button>
            </div>
            <div id="skill-tree-viewport">
                <div id="skill-tree-content" style="width: 2000px; height: 1500px;"></div>
            </div>
            <div style="position:absolute; bottom:20px; left:20px; pointer-events:none; color:#aaa; font-size:12px; background:rgba(0,0,0,0.5); padding:5px;">
                ãƒ”ãƒ³ãƒã§æ‹¡å¤§ç¸®å° / ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•
            </div>
        </div>

        <div id="logic-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title">AI ä½œæˆ</div>
                <button class="upgrade-btn" style="background:#00d2d3; color:#000; margin-right:10px;" onclick="applyAiLogic()">æ±ºå®š</button>
                <button class="close-btn" onclick="toggleMenu('logic-modal')">Ã—</button>
            </div>
            <div class="modal-content" style="padding:0;">
                <div id="blockly-div" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <div id="shop-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title" style="color:#f1c40f;">ãŠåº—</div>
                <button class="close-btn" onclick="toggleMenu('shop-modal')">Ã—</button>
            </div>
            <div class="modal-content">
                <div id="shop-message" style="background:#222; padding:10px; border-radius:4px; font-size:12px; margin-bottom:10px;">ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›...</div>
                <div id="shop-grid"></div>
            </div>
        </div>

        <div id="help-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
                <button class="close-btn" onclick="toggleMenu('help-modal')">Ã—</button>
            </div>
            <div class="modal-content">
                <div class="help-section">
                    <div class="help-title">âš”ï¸ è£…å‚™ã®ãƒ«ãƒ¼ãƒ«</div>
                    <div class="help-desc">
                        ãƒ»<span style="color:#e74c3c">èµ¤æ (ãƒ¡ã‚¤ãƒ³)</span>: æ”»æ’ƒGEMï¼ˆç«ã®ç‰ã€çŸ¢ãªã©ï¼‰<br>
                        ãƒ»<span style="color:#2ecc71">ç·‘æ (æ”¹é€ )</span>: è£œåŠ©GEMï¼ˆæ‹¡æ•£ã€è²«é€šãªã©ï¼‰<br>
                        â€» è‰²ãŒåˆã‚ãªã„å ´æ‰€ã«ç½®ã„ã¦ã‚‚åŠ¹æœãŒå‡ºã¾ã›ã‚“ï¼
                    </div>
                </div>
                <div class="help-section">
                    <div class="help-title">ğŸ’ è‡ªå‹•åˆæˆ (Fusion)</div>
                    <div class="help-desc">
                        åŒã˜ç¨®é¡ãƒ»åŒã˜ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ <strong>3ã¤</strong> æŒã¤ã¨ã€<br>
                        è‡ªå‹•çš„ã«åˆæˆã•ã‚Œ <strong>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</strong> ã—ã¾ã™ã€‚<br>
                        (ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå†…ã§ã‚‚è£…å‚™ä¸­ã§ã‚‚åˆ¤å®šã•ã‚Œã¾ã™)
                    </div>
                </div>
                <div class="help-section">
                    <div class="help-title">ğŸ® æ“ä½œæ–¹æ³•</div>
                    <div class="help-desc">
                        ãƒ»<strong>å³ã‚¯ãƒªãƒƒã‚¯ / Space</strong>: ã‚·ãƒ¼ãƒ«ãƒ‰å±•é–‹ (MPæ¶ˆè²»)<br>
                        ãƒ»<strong>Qã‚­ãƒ¼</strong>: è£…å‚™ã‚»ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆ (ãƒ¡ã‚¤ãƒ³ç”»é¢ã®SWAPãƒœã‚¿ãƒ³ã§ã‚‚å¯)<br>
                        ãƒ»<strong>Pã‚­ãƒ¼</strong>: ä¸€æ™‚åœæ­¢
                    </div>
                </div>
                <div class="help-section">
                    <div class="help-title">ğŸŒ² ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼</div>
                    <div class="help-desc">
                        ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã§SPã‚’ç²å¾—ã—ã€ãƒãƒ¼ãƒ‰ã‚’è§£æ”¾ã§ãã¾ã™ã€‚<br>
                        éš£æ¥ã™ã‚‹ãƒãƒ¼ãƒ‰ã—ã‹å–å¾—ã§ãã¾ã›ã‚“ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module" src="game.js"></script>
    <script src="blocks.js"></script>
    <script>
        // Simple pinch/drag handler for skill tree will be implemented in ui.js
        // Placeholder for close function
        function closeUpgradeModal() {
            document.getElementById('upgrade-selection-modal').classList.add('hidden');
            if(window.engineState) window.engineState.isPaused = false;
        }
    </script>
</body>
</html>