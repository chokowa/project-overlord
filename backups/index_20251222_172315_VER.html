<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project OVERLORD: Vertical Ops</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <style>
        :root {
            --bg-color: #0b0c10;
            --panel-bg: #1f2833;
            --accent-cyan: #66fcf1;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --text-main: #c5c6c7;
            --slot-border: #45a29e;
        }

        body, html { 
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: #000; color: var(--text-main); 
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif; 
            overflow: hidden; user-select: none;
            display: flex; justify-content: center; align-items: center;
        }

        #device-frame {
            position: relative;
            width: 100%; height: 100%; max-width: 600px; max-height: 900px;
            background: radial-gradient(circle at 50% 80%, #2c3e50 0%, #000000 100%);
            border: 2px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        #game-canvas { 
            width: 100%; height: 100%; 
            flex-grow: 1; display: block; 
        }

        /* --- PoE Style HUD (Bottom Panel) --- */
        #bottom-hud {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 140px;
            background: linear-gradient(to top, #0b0c10 80%, transparent 100%);
            display: flex; justify-content: space-between; align-items: flex-end;
            padding-bottom: 10px; z-index: 50;
            pointer-events: none; /* ‰∏ã„ÅÆ„É¨„Ç§„É§„Éº„Çí„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´ */
        }

        /* Orbs (HP / Energy) */
        .orb-container {
            width: 100px; height: 100px;
            position: relative;
            margin: 0 10px;
            pointer-events: auto;
            border-radius: 50%;
            background: #111;
            border: 4px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            overflow: hidden;
        }
        .orb-fill {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            transition: height 0.2s;
        }
        .orb-fill.hp {
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #c0392b);
            box-shadow: 0 0 20px #c0392b;
        }
        .orb-fill.energy {
            background: radial-gradient(circle at 30% 30%, #74b9ff, #2980b9);
            box-shadow: 0 0 20px #2980b9;
        }
        .orb-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: bold; font-size: 16px; color: #fff; text-shadow: 1px 1px 2px #000;
            pointer-events: none;
        }
        .orb-label {
            position: absolute; bottom: -20px; width: 100%; text-align: center;
            font-size: 12px; font-weight: bold; color: #aaa;
        }

        /* Center Panel (Controls & Stats) */
        .center-panel {
            flex-grow: 1; height: 100px;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            pointer-events: auto;
            margin-bottom: 5px;
        }

        .stats-row {
            display: flex; gap: 15px; margin-bottom: 5px;
            font-size: 12px; font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        .stat-item { color: #fff; display: flex; align-items: center; gap: 4px; }
        .stat-gold { color: #f1c40f; }
        .stat-sp { color: #00d2d3; }

        .xp-bar-container {
            width: 90%; height: 6px; background: #333;
            border: 1px solid #555; border-radius: 3px;
            margin-bottom: 8px; overflow: hidden;
        }
        .xp-bar-fill {
            height: 100%; background: #f1c40f; width: 0%; transition: width 0.3s;
        }

        .control-buttons {
            display: flex; gap: 10px;
        }
        .hud-btn {
            width: 45px; height: 45px;
            background: #1f2833; border: 2px solid #45a29e;
            border-radius: 8px; color: #66fcf1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: 0.1s;
        }
        .hud-btn:active { transform: scale(0.95); }
        .hud-btn span { font-size: 8px; margin-top: 2px; }
        .hud-btn.active { background: #66fcf1; color: #000; }

        /* Wave Info (Top Center - Minimal) */
        #top-info {
            position: absolute; top: 10px; left: 0; width: 100%;
            text-align: center; pointer-events: none;
        }
        .wave-badge {
            display: inline-block; background: rgba(0,0,0,0.6); 
            border: 1px solid #f1c40f; color: #f1c40f;
            padding: 5px 15px; border-radius: 15px;
            font-weight: bold; font-size: 14px;
        }
        .wave-progress {
            width: 200px; height: 4px; background: rgba(255,255,255,0.2);
            margin: 5px auto; border-radius: 2px; overflow: hidden;
        }
        .wave-progress-fill {
            height: 100%; background: #f1c40f; width: 0%;
        }

        /* --- Modals & Overlays --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 15, 20, 0.95); z-index: 100;
            display: flex; flex-direction: column;
            transition: opacity 0.2s; opacity: 1; pointer-events: auto;
        }
        .modal-overlay.hidden { opacity: 0; pointer-events: none; }

        .modal-header {
            padding: 15px; border-bottom: 2px solid #45a29e;
            display: flex; justify-content: space-between; align-items: center;
            background: #0b0c10;
        }
        .modal-title { font-size: 18px; font-weight: bold; color: #66fcf1; }
        .close-btn { background: none; border: none; color: #e74c3c; font-size: 28px; cursor: pointer; }

        .modal-content { flex-grow: 1; padding: 10px; overflow-y: auto; }

        /* Upgrade Selection (Vampire Survivors Style) */
        #upgrade-selection-modal {
            background: rgba(0, 0, 0, 0.85);
            align-items: center; justify-content: center;
        }
        .upgrade-container {
            display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 400px;
        }
        .upgrade-card {
            background: linear-gradient(135deg, #2c3e50, #1a1a2e);
            border: 2px solid #bdc3c7; border-radius: 8px;
            padding: 15px; color: #fff; cursor: pointer;
            display: flex; align-items: center; gap: 15px;
            transition: transform 0.2s;
            position: relative; overflow: hidden;
        }
        .upgrade-card:hover { transform: scale(1.03); border-color: #f1c40f; background: linear-gradient(135deg, #34495e, #2c3e50); }
        .upgrade-card.rare { border-color: #f1c40f; }
        .upgrade-icon { font-size: 32px; width: 50px; text-align: center; }
        .upgrade-info { flex: 1; }
        .upgrade-name { font-weight: bold; font-size: 16px; color: #f1c40f; margin-bottom: 4px; }
        .upgrade-desc { font-size: 12px; color: #ccc; line-height: 1.3; }
        .upgrade-btn {
            margin-top: 10px; padding: 10px; background: #333; border: 1px solid #777; 
            color: #fff; cursor: pointer; border-radius: 4px; text-align: center;
        }

        /* Skill Tree Container (Zoomable) */
        #skill-tree-viewport {
            width: 100%; height: 100%; overflow: hidden; position: relative;
            background: radial-gradient(circle, #222 0%, #000 100%);
            touch-action: none; /* Prevent browser default zoom */
        }
        #skill-tree-content {
            transform-origin: 0 0;
            position: absolute;
        }

        /* --- Specific Modal Styles --- */
        .equipment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gem-slot {
            height: 60px; background: rgba(0,0,0,0.5); border: 1px solid #555;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px; font-size: 12px; color: #888;
        }
        #inventory-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .inv-item { 
            aspect-ratio: 1; border: 1px solid #444; border-radius: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 10px; background: rgba(255,255,255,0.05);
        }

        /* Shop Grid */
        #shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    </style>
</head>
<body>
    <div id="device-frame">
        <canvas id="game-canvas" width="600" height="900"></canvas>
        
        <div id="top-info">
            <div class="wave-badge" id="wave-info">WAVE 1</div>
            <div class="wave-progress">
                <div id="wave-bar-fill" class="wave-progress-fill"></div>
            </div>
            <div id="game-stats" style="font-size: 10px; color: #aaa; margin-top: 4px;">ÂàùÊúüÂåñ‰∏≠...</div>
        </div>

        <div id="bottom-hud">
            <div class="orb-container left">
                <div id="hp-orb-fill" class="orb-fill hp" style="height: 100%;"></div>
                <div class="orb-text">HP</div>
                <div class="orb-label" id="hp-text">500</div>
            </div>

            <div class="center-panel">
                <div class="stats-row">
                    <div class="stat-item stat-gold">üí∞ <span id="gold-display">0</span></div>
                    <div class="stat-item stat-sp">‚ú® SP: <span id="sp-display">0</span></div>
                </div>
                
                <div class="xp-bar-container">
                    <div id="xp-bar-fill" class="xp-bar-fill"></div>
                </div>
                <div style="font-size: 8px; color:#aaa; margin-bottom: 5px;">„Åë„ÅÑ„Åë„Çì„Å°</div>

                <div class="control-buttons">
                    <div class="hud-btn" onclick="toggleMenu('dock-modal')">
                        üéí<span>„Åù„ÅÜ„Å≥</span>
                    </div>
                    <div class="hud-btn" onclick="toggleMenu('skill-tree-modal')">
                        üå≤<span>„ÉÑ„É™„Éº</span>
                    </div>
                    <div class="hud-btn" id="btn-shield" 
                         onmousedown="engineState.setShieldState(true)" 
                         onmouseup="engineState.setShieldState(false)"
                         ontouchstart="engineState.setShieldState(true); event.preventDefault();" 
                         ontouchend="engineState.setShieldState(false); event.preventDefault();">
                        üõ°Ô∏è<span>„Ç¨„Éº„Éâ</span>
                    </div>
                    <div class="hud-btn" onclick="toggleMenu('logic-modal')">
                        ü§ñ<span>AI</span>
                    </div>
                    <div class="hud-btn" onclick="toggleMenu('shop-modal')">
                        üõí<span>Â∫ó</span>
                    </div>
                </div>
            </div>

            <div class="orb-container right">
                <div id="energy-orb-fill" class="orb-fill energy" style="height: 100%;"></div>
                <div class="orb-text">MP</div>
                <div class="orb-label" id="energy-text">100</div>
            </div>
        </div>

        <div style="position:absolute; bottom:150px; right:10px; width:40px; height:40px; 
             background:rgba(0,0,0,0.5); border:2px solid #fff; color:#fff; border-radius:50%; 
             display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer; z-index:90;"
             onclick="engineState.togglePause()">‚è∏</div>

        <div id="upgrade-selection-modal" class="modal-overlay hidden">
            <h2 style="color:#f1c40f; text-shadow:0 0 10px orange; margin-bottom:20px;">„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ</h2>
            <div class="upgrade-container" id="upgrade-options-container">
                </div>
            <div class="upgrade-btn" onclick="closeUpgradeModal()">„ÅÇ„Å®„ÅßÊ±∫„ÇÅ„ÇãÔºàSP„Çí‰øùÊåÅÔºâ</div>
        </div>

        <div id="dock-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title">„Åù„ÅÜ„Å≥Â§âÊõ¥</div>
                <button class="close-btn" onclick="toggleMenu('dock-modal')">√ó</button>
            </div>
            <div class="modal-content">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="upgrade-btn" style="flex:1" onclick="engineState.selectLoadout(1)">„Çª„ÉÉ„Éà I</button>
                    <button class="upgrade-btn" style="flex:1" onclick="engineState.selectLoadout(2)">„Çª„ÉÉ„Éà II</button>
                </div>
                <div class="equipment-grid">
                    <div>
                        <div style="text-align:center; font-size:10px; color:#aaa; margin-bottom:4px;">„É°„Ç§„É≥Ê≠¶Âô®</div>
                        <div class="gem-slot" id="slot-0" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 0)">„É°„Ç§„É≥</div>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <div class="gem-slot" id="slot-1" style="flex:1" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 1)">ÊîπÈÄ†</div>
                            <div class="gem-slot" id="slot-2" style="flex:1" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 2)">ÊîπÈÄ†</div>
                        </div>
                    </div>
                    <div>
                        <div style="text-align:center; font-size:10px; color:#aaa; margin-bottom:4px;">„Ç¢„ÇØ„Çª„Çµ„É™„Éº</div>
                        <div class="gem-slot" id="slot-ring" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 'RING')">ÊåáËº™</div>
                        <div class="gem-slot" id="slot-amulet" style="margin-top:5px;" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SLOT', 'AMULET')">È¶ñÈ£æ„Çä</div>
                    </div>
                </div>
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:5px;">ÊåÅ„Å°Áâ©</div>
                <div id="inventory-grid" ondragover="allowDrop(event)" ondrop="handleDrop(event, 'INVENTORY')"></div>
                <div id="salvage-area" style="margin-top:15px; border:2px dashed #e74c3c; color:#e74c3c; padding:10px; text-align:center; font-size:12px;"
                     ondragover="allowDrop(event)" ondrop="handleDrop(event, 'SALVAGE')">„Åì„Åì„Å´Êç®„Å¶„Å¶ XP „Å´Â§âÊèõ</div>
            </div>
        </div>

        <div id="skill-tree-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title">„Çπ„Ç≠„É´„ÉÑ„É™„Éº</div>
                <button class="close-btn" onclick="toggleMenu('skill-tree-modal')">√ó</button>
            </div>
            <div id="skill-tree-viewport">
                <div id="skill-tree-content" style="width: 2000px; height: 1500px;"></div>
            </div>
            <div style="position:absolute; bottom:20px; left:20px; pointer-events:none; color:#aaa; font-size:12px; background:rgba(0,0,0,0.5); padding:5px;">
                „Éî„É≥„ÉÅ„ÅßÊã°Â§ßÁ∏ÆÂ∞è / „Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï
            </div>
        </div>

        <div id="logic-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title">AI ‰ΩúÊàê</div>
                <button class="upgrade-btn" style="background:#00d2d3; color:#000; margin-right:10px;" onclick="applyAiLogic()">Ê±∫ÂÆö</button>
                <button class="close-btn" onclick="toggleMenu('logic-modal')">√ó</button>
            </div>
            <div class="modal-content" style="padding:0;">
                <div id="blockly-div" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <div id="shop-modal" class="modal-overlay hidden">
            <div class="modal-header">
                <div class="modal-title" style="color:#f1c40f;">„ÅäÂ∫ó</div>
                <button class="close-btn" onclick="toggleMenu('shop-modal')">√ó</button>
            </div>
            <div class="modal-content">
                <div id="shop-message" style="background:#222; padding:10px; border-radius:4px; font-size:12px; margin-bottom:10px;">„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åõ...</div>
                <div id="shop-grid"></div>
            </div>
        </div>
    </div>
    
    <script type="module" src="game.js"></script>
    <script src="blocks.js"></script>
    <script>
        // Simple pinch/drag handler for skill tree will be implemented in ui.js
        // Placeholder for close function
        function closeUpgradeModal() {
            document.getElementById('upgrade-selection-modal').classList.add('hidden');
            if(window.engineState) window.engineState.isPaused = false;
        }
    </script>
</body>
</html>