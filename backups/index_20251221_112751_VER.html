<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Castle Guardian: Gem Link - UI Refined</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100vh; 
            background: #0a0a0c; color: #ecf0f1; 
            font-family: 'Segoe UI', 'Hiragino Kaku Gothic ProN', sans-serif; overflow: hidden; 
        }

        #main-layout {
            display: grid;
            grid-template-rows: 1fr 340px; 
            height: 100vh; width: 100vw;
        }

        #game-viewport {
            position: relative;
            background: radial-gradient(circle at 20% 50%, #1a1a2e 0%, #050505 100%);
            border-bottom: 2px solid #1f1f2e;
            overflow: hidden;
        }

        #game-canvas { width: 100%; height: 100%; display: block; }

        #ui-control-panel {
            background: #161625;
            display: grid;
            grid-template-columns: 350px 1fr 300px; 
            gap: 12px;
            padding: 12px;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.7);
        }

        /* インベントリ改善 */
        .inventory-board {
            background: #1c1c2e; padding: 12px; border-radius: 10px;
            display: flex; flex-direction: column; border: 1px solid #2d2d44;
        }

        #inventory-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 8px; overflow-y: auto; flex-grow: 1; padding-right: 5px;
        }

        .inv-item { 
            width: 100%; aspect-ratio: 1; border-radius: 6px; 
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold; color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            transition: all 0.2s; position: relative;
            background-size: cover;
        }
        .inv-item:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-color: #fff; }

        /* Blockly ワークスペース */
        #blockly-area { position: relative; background: #fff; border-radius: 10px; overflow: hidden; }
        #blockly-div { position: absolute; top: 0; left: 0; bottom: 0; right: 0; }

        .btn-apply {
            background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none;
            padding: 6px 20px; border-radius: 20px; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 10px rgba(39,174,96,0.3);
        }

        /* 装備スロット改善 */
        .socket-board {
            background: #1c1c2e; padding: 12px; border-radius: 10px; border: 1px solid #2d2d44;
        }
        .socket-group {
            display: flex; flex-direction: column; gap: 10px; margin-top: 15px;
        }
        .gem-slot {
            height: 55px; border: 2px solid #2d2d44;
            border-radius: 8px; display: flex; align-items: center;
            padding: 0 15px; font-size: 12px; font-weight: bold;
            cursor: pointer; background: rgba(0,0,0,0.2); transition: 0.3s;
        }
        .gem-slot.active-type { border-left: 6px solid #f1c40f; }
        .gem-slot.support-type { border-left: 6px solid #3498db; }
        .gem-slot:hover { background: rgba(255,255,255,0.05); }

        /* HUD */
        #hud-container { position: absolute; top: 20px; left: 20px; width: 280px; }
        .bar-bg { background: rgba(0,0,0,0.5); height: 8px; border-radius: 4px; margin-bottom: 6px; overflow: hidden; border: 1px solid #333; }
        .bar-fill-hp { background: #ff4757; height: 100%; transition: width 0.3s; }
        .bar-fill-xp { background: #2ed573; height: 100%; transition: width 0.1s; }
    </style>
</head>
<body>
    <div id="main-layout">
        <div id="game-viewport">
            <canvas id="game-canvas" width="1200" height="600"></canvas>
            <div id="hud-container">
                <div style="font-size: 10px; color: #aaa; margin-bottom: 4px;">CASTLE STATUS</div>
                <div class="bar-bg"><div id="hp-bar-fill" class="bar-fill-hp"></div></div>
                <div style="font-size: 10px; color: #aaa; margin-bottom: 4px;">EXPERIENCE GAIN</div>
                <div class="bar-bg"><div id="xp-bar-fill" class="bar-fill-xp"></div></div>
                <div id="game-stats" style="font-size: 12px; color: #eee; margin-top: 8px;"></div>
            </div>
        </div>
        <div id="ui-control-panel">
            <div class="inventory-board">
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #3498db;">STORAGE</div>
                <div id="inventory-grid"></div>
            </div>
            <div id="blockly-area">
                <div style="position: absolute; top: 10px; right: 10px; z-index: 50;">
                    <button class="btn-apply" onclick="applyAiLogic()">APPLY AI</button>
                </div>
                <div id="blockly-div"></div>
            </div>
            <div class="socket-board">
                <div style="font-size: 14px; font-weight: bold; color: #f1c40f;">EQUIPMENT</div>
                <div class="socket-group">
                    <div class="gem-slot active-type" id="slot-0" data-index="0">ACTIVE</div>
                    <div class="gem-slot support-type" id="slot-1" data-index="1">SUPPORT 1</div>
                    <div class="gem-slot support-type" id="slot-2" data-index="2">SUPPORT 2</div>
                </div>
            </div>
        </div>
    </div>
    <script type="module" src="game.js"></script>
    <script src="blocks.js"></script>
</body>
</html>